name: Automated Content Generation

on:
  schedule:
    # Kör automatiskt varje måndag och torsdag kl 10:00 UTC (11:00 svensk tid)
    - cron: '0 10 * * 1,4'

  workflow_dispatch:
    # Tillåt manuell körning från GitHub Actions UI
    inputs:
      force_generate:
        description: 'Force generate new content'
        required: false
        default: 'false'

jobs:
  generate-content:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # Inga extra dependencies behövs för basic script

    - name: Configure git
      run: |
        git config --local user.email "automation@kitchenprohub.com"
        git config --local user.name "KitchenPro Content Bot"

    - name: Check for recent content
      id: check_recent
      run: |
        # Kontrollera om det finns content genererat de senaste 2 dagarna
        RECENT_COMMITS=$(git log --since="2 days ago" --grep="Auto-generated" --oneline | wc -l)
        echo "recent_commits=$RECENT_COMMITS" >> $GITHUB_OUTPUT

        if [ "$RECENT_COMMITS" -gt 0 ] && [ "${{ github.event.inputs.force_generate }}" != "true" ]; then
          echo "should_generate=false" >> $GITHUB_OUTPUT
          echo "Recent content found, skipping generation"
        else
          echo "should_generate=true" >> $GITHUB_OUTPUT
          echo "No recent content or forced generation, proceeding"
        fi

    - name: Generate new content
      if: steps.check_recent.outputs.should_generate == 'true'
      run: |
        echo "🚀 Starting content generation..."
        python automation/content_generator.py

    - name: Check for changes
      if: steps.check_recent.outputs.should_generate == 'true'
      id: verify_changes
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "changes_detected=true" >> $GITHUB_OUTPUT
          echo "✅ New content generated"
          git status --porcelain
        else
          echo "changes_detected=false" >> $GITHUB_OUTPUT
          echo "⚠️ No changes detected"
        fi

    - name: Commit and push changes
      if: steps.verify_changes.outputs.changes_detected == 'true'
      run: |
        # Add alla ändringar
        git add .

        # Skapa commit med timestamp
        TIMESTAMP=$(date '+%Y-%m-%d %H:%M UTC')
        git commit -m "🤖 Auto-generated new product review - $TIMESTAMP

        - Added new kitchen product review with expert testing
        - Updated homepage featured content
        - Updated reviews page
        - 3 affiliate links included
        - SEO optimized content
        - Mobile responsive design

        Generated by: KitchenPro Content Bot
        Website: www.kitchenprohub.com"

        # Push ändringar
        git push origin main

    - name: Verify deployment
      if: steps.verify_changes.outputs.changes_detected == 'true'
      run: |
        echo "🎉 Content generation completed!"
        echo "📊 Summary:"
        echo "- New product review generated"
        echo "- Homepage and reviews page updated"
        echo "- Changes pushed to main branch"
        echo "- GitHub Pages will deploy automatically"
        echo ""
        echo "🔗 Check your website in 2-5 minutes:"
        echo "   https://www.kitchenprohub.com"

    - name: Create workflow summary
      if: always()
      run: |
        echo "## 🍳 KitchenPro Hub Content Generation Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Date:** $(date '+%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
        echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ steps.check_recent.outputs.should_generate }}" == "true" ]; then
          if [ "${{ steps.verify_changes.outputs.changes_detected }}" == "true" ]; then
            echo "✅ **Status:** New content generated successfully" >> $GITHUB_STEP_SUMMARY
            echo "📝 **Action:** Homepage and reviews page updated" >> $GITHUB_STEP_SUMMARY
            echo "🔗 **Website:** https://www.kitchenprohub.com" >> $GITHUB_STEP_SUMMARY
            echo "💰 **Monetization:** 3 affiliate links + AdSense ads included" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ **Status:** Content generation failed - no changes detected" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "⏭️ **Status:** Skipped - recent content exists" >> $GITHUB_STEP_SUMMARY
          echo "🕒 **Next run:** Next scheduled time or manual trigger" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Recent commits with auto-generated content:** ${{ steps.check_recent.outputs.recent_commits }}" >> $GITHUB_STEP_SUMMARY
