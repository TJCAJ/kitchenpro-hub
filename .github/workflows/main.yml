name: Automated Content Generation

on:
  schedule:
    # Kör automatiskt varje måndag och torsdag kl 10:00 UTC (12:00 svensk sommartid)
    - cron: '0 10 * * 1,4'

  workflow_dispatch:
    # Tillåt manuell körning från GitHub Actions UI
    inputs:
      force_run:
        description: 'Force a generation run'
        required: false

# KORREKT: Ger tillåtelse att skriva till repot
permissions:
  contents: write

jobs:
  generate-content:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    # KORREKT: Installerar från requirements.txt
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    - name: Configure git
      run: |
        git config --local user.email "automation@kitchenprohub.com"
        git config --local user.name "KitchenPro Content Bot"

    # KORREKT: Skickar med API-nyckel och anropar RÄTT fil
    - name: Generate new content and image
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        echo "🚀 Starting content generation..."
        python automation/improved_content_generator.py

    - name: Check for file changes
      id: verify_changes
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "changes_detected=true" >> $GITHUB_OUTPUT
          echo "✅ New files or changes were detected."
          git status --porcelain
        else
          echo "changes_detected=false" >> $GITHUB_OUTPUT
          echo "⚠️ No file changes were generated by the script."
        fi

    # KORREKT: Robust och enkel commit
    - name: Commit and push changes
      if: steps.verify_changes.outputs.changes_detected == 'true'
      run: |
        git add .
        TIMESTAMP=$(date '+%Y-%m-%d %H:%M UTC')
        git commit -m "🤖 Auto: Generate new content and image - ${TIMESTAMP}"
        git push origin main

    - name: Create workflow summary
      if: always()
      run: |
        echo "## 🍳 KitchenPro Hub Content Generation Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Date:** $(date '+%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
        echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.verify_changes.outputs.changes_detected }}" == "true" ]; then
          echo "✅ **Status:** New content was generated and pushed successfully." >> $GITHUB_STEP_SUMMARY
        else
          echo "⚠️ **Status:** Script ran, but no file changes were detected to commit." >> $GITHUB_STEP_SUMMARY
          echo "   (This often indicates an error in the Python script or a problem with the API call. Check the 'Generate new content' step log for errors.)" >> $GITHUB_STEP_SUMMARY
        fi